name: GA7 - GKE Deploy & Stress Test

on:
  push:
    branches: ["ga6-cd"]
  workflow_dispatch:

jobs:
  stress-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      # 1. Authenticate to Google Cloud using service account JSON
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}
          create_credentials_file: true
          export_environment_variables: true

      # 2. Install gcloud and gke-gcloud-auth-plugin for kubectl
      - name: Install gcloud + GKE auth plugin
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: ">=467.0.0"

      - name: Ensure GKE auth plugin installed
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet || true
          if ! command -v gke-gcloud-auth-plugin >/dev/null; then
            echo "Installing via apt..."
            echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
            sudo apt-get update -y
            sudo apt-get install -y google-cloud-cli google-cloud-sdk-gke-gcloud-auth-plugin
          fi
          gke-gcloud-auth-plugin --version

      # 3. Setup kubectl
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      # 4. Decode kubeconfig
      - name: Configure kubeconfig from base64 secret
        env:
          KUBE_CONFIG_B64: ${{ secrets.KUBE_CONFIG_B64 }}
        run: |
          echo "$KUBE_CONFIG_B64" | base64 --decode > kubeconfig.yaml
          echo "KUBECONFIG=$PWD/kubeconfig.yaml" >> $GITHUB_ENV
          echo "âœ… kubeconfig configured"

      # 5. Verify cluster connectivity
      - name: Verify cluster connection
        run: |
          kubectl version --client=true
          echo "Cluster Nodes:"
          kubectl get nodes

      # 6. Apply Kubernetes manifests
      - name: Apply manifests
        run: |
          echo "ðŸ›  Deploying iris-api and service..."
          kubectl apply -f k8s/deploy.yaml
          kubectl rollout status deploy/iris-api --timeout=120s
          kubectl get svc iris-api-svc

      # 7. Create Horizontal Pod Autoscaler
      - name: Configure HPA
        run: |
          kubectl autoscale deployment iris-api --cpu-percent=50 --min=1 --max=3 || true
          kubectl get hpa

      # 8. Fetch External IP for service
      - name: Get External IP
        id: svc
        run: |
          echo "Fetching external IP for iris-api-svc..."
          for i in {1..10}; do
            IP=$(kubectl get svc iris-api-svc -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
            if [ -n "$IP" ]; then
              echo "External IP: $IP"
              echo "EXTERNAL_IP=$IP" >> $GITHUB_ENV
              break
            fi
            echo "Waiting for external IP..."
            sleep 10
          done

      # 9. Run stress test with wrk
      - name: Run wrk stress test
        run: |
          sudo apt-get update && sudo apt-get install -y wrk
          cat > post.lua <<'LUA'
          wrk.method = "POST"
          wrk.body   = '{"sepal_length":5.1,"sepal_width":3.5,"petal_length":1.4,"petal_width":0.2}'
          wrk.headers["Content-Type"] = "application/json"
          LUA
          echo "ðŸš€ Starting stress test for 60 seconds..."
          wrk -t4 -c400 -d60s -s post.lua http://$EXTERNAL_IP/predict || echo "wrk finished with errors"

      # 10. Show HPA and Pod status after load
      - name: Show HPA and Pod status
        run: |
          echo "ðŸ“ˆ HPA after load:"
          kubectl get hpa
          echo "ðŸ§© Pod status:"
          kubectl get pods -o wide
          echo "ðŸ’¾ Pod metrics:"
          kubectl top pods || echo "metrics unavailable"
