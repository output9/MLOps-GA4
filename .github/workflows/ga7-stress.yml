name: GA7 - GKE Deploy & Stress Test

on:
  push:
    branches: ["ga6-cd"]
  workflow_dispatch:

jobs:
  stress-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      - name: Configure kubeconfig from base64 secret
        env:
          KUBE_CONFIG_B64: ${{ secrets.KUBE_CONFIG_B64 }}
        run: |
          echo "$KUBE_CONFIG_B64" | base64 --decode > kubeconfig.yaml
          echo "KUBECONFIG=$PWD/kubeconfig.yaml" >> $GITHUB_ENV
          echo "âœ… Kubeconfig written and configured"

      - name: Verify cluster connection
        run: |
          kubectl version --client=true
          echo "Cluster nodes:"
          kubectl get nodes

      - name: Apply manifests (deploy + service)
        run: |
          echo "ðŸ›  Applying Kubernetes manifests..."
          kubectl apply -f k8s/deploy.yaml
          kubectl rollout status deploy/iris-api --timeout=120s
          kubectl get svc iris-api-svc

      - name: Configure Horizontal Pod Autoscaler (1â€“3 pods @ 50% CPU)
        run: |
          kubectl autoscale deployment iris-api --cpu-percent=50 --min=1 --max=3 || true
          echo "HPA configuration complete."
          kubectl get hpa

      - name: Get External IP
        id: svc
        run: |
          echo "Fetching external IP for iris-api-svc..."
          for i in {1..10}; do
            IP=$(kubectl get svc iris-api-svc -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
            if [ -n "$IP" ]; then
              echo "External IP: $IP"
              echo "EXTERNAL_IP=$IP" >> $GITHUB_ENV
              break
            fi
            echo "Waiting for external IP..."
            sleep 10
          done

      - name: Run wrk stress test (POST /predict)
        run: |
          sudo apt-get update && sudo apt-get install -y wrk
          cat > post.lua <<'LUA'
          wrk.method = "POST"
          wrk.body   = '{"sepal_length":5.1,"sepal_width":3.5,"petal_length":1.4,"petal_width":0.2}'
          wrk.headers["Content-Type"] = "application/json"
          LUA
          echo "ðŸš€ Starting stress test for 60 seconds..."
          wrk -t4 -c400 -d60s -s post.lua http://$EXTERNAL_IP/predict || echo "wrk finished with non-zero exit code"

      - name: Show HPA and Pod Status After Load
        run: |
          echo "ðŸ“ˆ HPA status after load test:"
          kubectl get hpa
          echo "ðŸ§© Pods state after scaling:"
          kubectl get pods -o wide
          echo "ðŸ’¾ Pod resource usage:"
          kubectl top pods || echo "metrics unavailable"

